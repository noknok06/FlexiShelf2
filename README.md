# 棚割りアプリ機能要件定義書

## 1. 棚割り機能概要

### 1.1 目的
- 実際のスーパーの棚を正確にデジタル再現
- 商品の物理サイズを考慮した配置システム
- フェーシング（同一商品の横並び）による実際の陳列状況の表現
- 段別管理による柔軟な棚構成

### 1.2 基本概念
- **棚（Shelf）**: 物理的な棚の器
- **段（Segment）**: 棚板で区切られた各階層
- **配置（Placement）**: 段内での商品の位置と数量
- **フェーシング**: 同一商品の横並び配置数

## 2. 棚構造管理

### 2.1 棚基本情報

#### 2.1.1 必須項目
```python
# 棚マスタ
class Shelf(models.Model):
    name = models.CharField('棚名', max_length=100)           # 例: "エンド陳列棚A"
    width = models.FloatField('幅(cm)')                      # 例: 120.0
    depth = models.FloatField('奥行(cm)')                    # 例: 40.0
    description = models.TextField('説明', blank=True)       # 設置場所、特徴等
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

#### 2.1.2 棚作成フロー
1. **基本情報入力**: 棚名、寸法入力
2. **段構成設定**: 段数と各段の高さ設定
3. **プレビュー確認**: 作成される棚の視覚確認
4. **作成実行**: 棚と段の一括作成

### 2.2 段（セグメント）管理

#### 2.2.1 段の属性
```python
# 段マスタ
class ShelfSegment(models.Model):
    shelf = models.ForeignKey(Shelf, on_delete=models.CASCADE)
    level = models.IntegerField('段番号')                    # 1=最下段, 2,3,4...
    height = models.FloatField('段高さ(cm)')                 # 例: 35.0
    y_position = models.FloatField('床からの位置(cm)')        # 自動計算
    is_active = models.BooleanField(default=True)
```

#### 2.2.2 段高さ調整機能
- **個別調整**: 各段の高さを独立して調整可能
- **制約チェック**: 配置済み商品が収まるかの自動検証
- **再配置提案**: 収まらない商品の移動先提案

**段高さ調整UI仕様:**
```
段4: [▼ 40cm ▲]  ← 最上段
段3: [▼ 35cm ▲]
段2: [▼ 30cm ▲]
段1: [▼ 25cm ▲]  ← 最下段
```

## 3. 商品配置システム

### 3.1 配置の基本概念

#### 3.1.1 座標系
- **X座標**: 段内での左端からの距離（cm）
- **Y座標**: 段レベルで管理（段番号で指定）
- **占有幅**: 商品幅 × フェース数

#### 3.1.2 配置データモデル
```python
class ProductPlacement(models.Model):
    shelf = models.ForeignKey(Shelf, on_delete=models.CASCADE)
    segment = models.ForeignKey(ShelfSegment, on_delete=models.CASCADE)
    product = models.ForeignKey('Product', on_delete=models.CASCADE)
    x_position = models.FloatField('X座標(cm)')
    face_count = models.IntegerField('フェース数', default=1)
    occupied_width = models.FloatField('占有幅(cm)')          # 自動計算
    placement_order = models.IntegerField('配置順序', default=0)
    created_at = models.DateTimeField(auto_now_add=True)
```

### 3.2 配置操作方法

#### 3.2.1 配置方法の選択肢
- **クリック配置**: 商品選択 → 配置位置クリック
- **ドラッグ&ドロップ**: 商品パレットから棚へドラッグ
- **コピー**: 配置済みの商品を複製
- **お気に入り商品**: よく使用する商品からの簡単配置

#### 3.2.2 配置操作フロー
```
1. 商品選択
   ↓
2. 配置可能段の表示（高さ制約による自動フィルタ）
   ↓
3. 段選択 & 位置指定
   ↓
4. フェース数設定
   ↓
5. 制約チェック（重複・幅超過等）
   ↓
6. 配置実行 または エラー表示
```

### 3.3 配置制約システム

#### 3.3.1 物理制約
- **高さ制約**: 商品高さが段高さに収まること
- **幅制約**: 占有幅が段幅に収まること
- **重複制約**: 同一位置への複数商品配置禁止
- **境界制約**: 段の境界を超えた配置禁止

#### 3.3.2 制約チェック処理
```python
def validate_placement(self, product, segment, x_position, face_count):
    """配置制約チェック"""
    errors = []
    
    # 高さチェック
    if product.height > segment.height:
        errors.append("商品高さが段高さを超えています")
    
    # 幅チェック
    occupied_width = product.width * face_count
    if x_position + occupied_width > segment.shelf.width:
        errors.append("段幅を超える配置です")
    
    # 重複チェック
    if self.check_overlap(segment, x_position, occupied_width):
        errors.append("他の商品と重複しています")
    
    return errors
```

## 4. フェーシング機能

### 4.1 フェーシングの概念

#### 4.1.1 定義
- 同一商品を横に並べて配置すること
- **1フェース**: 商品1個分の幅
- **3フェース**: 同じ商品を3個横並び（商品幅×3の占有）

#### 4.1.2 フェーシング設定パラメータ
- **最小フェース数**: 商品ごとの最小配置数
- **最大フェース数**: 段幅による制限
- **推奨フェース数**: 売上データに基づく提案

### 4.2 フェーシング操作

#### 4.2.1 フェース数変更UI

**配置時設定:**
```
商品選択: [コカ・コーラ 500ml]
フェース数: [1] [2] [3] [4] [5] ← クリック選択
占有幅プレビュー: 19.5cm (6.5cm × 3個)
```

**配置後変更:**
```
配置済み商品クリック → フェース数編集ダイアログ
現在: 3フェース (19.5cm)
変更: [1] [2] [3] [4] [5]
```

#### 4.2.2 フェーシング制約
- **商品制約**: 商品ごとの最大・最小フェース数
- **段幅制約**: 段の残り幅に収まる最大フェース数
- **実用制約**: 極端に多いフェース数への警告

### 4.3 フェース数最適化

#### 4.3.1 自動提案機能
- **売上連動**: 売上高に応じたフェース数提案
- **在庫連動**: 在庫数量を考慮した適正フェース数
- **スペース効率**: 段の無駄スペースを最小化する配置提案

## 5. 棚割り表示システム

### 5.1 表示モード

#### 5.1.1 キャンバス表示
- **2D平面表示**: 棚を真正面から見た状態
- **スケール自動調整**: 棚サイズに応じた表示倍率
- **段別色分け**: 段ごとの背景色変更オプション
- **グリッド表示**: 配置精度向上のための補助線

### 5.2 商品表示

#### 5.2.1 商品表示要素
- **商品画像**: サムネイル表示（縦横比維持）
- **商品名**: 短縮表示（15文字程度）
- **メーカー名**: 小さく表示
- **フェース数バッジ**: 2個以上の場合に「×3」等を表示
- **価格表示**: オプション機能

#### 5.2.2 表示オプション
- **表示倍率**: 25%, 50%, 75%, 100%, 150%
- **情報表示切替**: 商品名のみ/画像のみ/詳細情報
- **ハイライト**: 選択中商品、エラー商品の強調表示

## 6. 追加検討事項

### 6.1 操作性向上機能
- **元に戻す/やり直し**: 操作履歴管理
- **一括操作**: 複数商品の同時移動・削除
- **検索機能**: 商品名・JANコードによる商品検索
- **テンプレート**: よく使用する棚割りパターンの保存

### 6.2 データ管理
- **バージョン管理**: 棚割り変更履歴の保持
- **バックアップ**: 定期的な自動保存
- **インポート/エクスポート**: CSV、Excel形式での入出力

### 6.3 分析・レポート機能
- **スペース効率**: 棚使用率の計算
- **商品配置分析**: カテゴリ別配置状況
- **変更履歴**: 棚割り変更の追跡

### 6.4 連携機能
- **POSシステム連携**: 売上データの取り込み
- **在庫システム連携**: 在庫数量の反映
- **発注システム連携**: 棚割りに基づく発注提案