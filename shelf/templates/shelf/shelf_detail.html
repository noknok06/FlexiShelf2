<!-- shelf/templates/shelf/shelf_detail.html -->

{% extends 'shelf/base.html' %}
{% load shelf_extras %}

{% block title %}{{ title }} - æ£šå‰²ã‚Šã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<style>
    .shelf-container {
        position: relative;
        margin-left: 20px;
    }
    
    .shelf-level {
        position: relative;
        background: linear-gradient(to right, #f8fafc 0%, #f1f5f9 100%);
        border: 2px solid #e2e8f0;
        height: 60px; /* å›ºå®šé«˜ã• */
        border-radius: 8px;
        margin-bottom: 8px;
        padding: 4px;
        transition: all 0.2s ease;
        cursor: crosshair;
        display: flex;
        align-items: center; /* å•†å“ã‚’Yè»¸ä¸­å¤®ã«é…ç½® */
    }
    
    .shelf-level:hover {
        border-color: #06b6d4;
        box-shadow: 0 4px 8px rgba(6, 182, 212, 0.1);
    }
    
    .shelf-level.drag-over {
        background: linear-gradient(to right, #ecfdf5 0%, #d1fae5 100%);
        border-color: #10b981;
        border-style: dashed;
    }
    
    .shelf-level.drop-available {
        background: linear-gradient(to right, #f0fdf4 0%, #dcfce7 100%);
        border-color: #22c55e;
        border-style: dashed;
    }
    
    .shelf-level.drop-unavailable {
        background: linear-gradient(to right, #fef2f2 0%, #fee2e2 100%);
        border-color: #ef4444;
        border-style: dashed;
        cursor: not-allowed;
    }
    
    .segment-label {
        position: absolute;
        left: -15px;
        top: 50%;
        transform: translateY(-50%);
        background: #1e293b;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        z-index: 2;
    }
    
    .segment-info {
        position: absolute;
        top: 4px;
        right: 8px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        z-index: 3;
    }
    
    .product-in-shelf {
        position: absolute;
        cursor: move;
        transition: all 0.2s ease;
        border: 2px solid #06b6d4;
        border-radius: 6px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2px;
        z-index: 5;
        height: 50px; /* å›ºå®šé«˜ã• */
        top: 5px; /* å›ºå®šYåº§æ¨™ */
    }
    
    .product-in-shelf:hover {
        border-color: #0891b2;
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        z-index: 10;
        transform: scale(1.02);
    }
    
    .product-in-shelf.dragging {
        opacity: 0.7;
        transform: rotate(2deg) scale(1.05);
        z-index: 20;
        border-color: #f59e0b;
    }
    
    .product-info {
        text-align: center;
        font-size: 8px;
        line-height: 1.2;
    }
    
    .product-name {
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 1px;
    }
    
    .product-price {
        color: #6b7280;
        font-size: 7px;
    }
    
    .facing-indicator {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #dc2626;
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: bold;
        z-index: 6;
    }
    
    .facing-controls {
        position: absolute;
        top: -8px;
        right: 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        display: none;
        z-index: 15;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .product-in-shelf:hover .facing-controls {
        display: flex;
    }
    
    .facing-btn {
        padding: 2px 6px;
        font-size: 10px;
        background: #f9fafb;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .facing-btn:hover {
        background: #e5e7eb;
    }
    
    .remove-product-btn {
        padding: 2px 6px;
        font-size: 10px;
        background: #fee2e2;
        color: #dc2626;
        border: none;
        cursor: pointer;
        margin-left: 2px;
        transition: background-color 0.2s;
    }
    
    .remove-product-btn:hover {
        background: #fecaca;
    }
    
    .product-palette {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    
    .product-palette-item {
        cursor: grab;
        transition: all 0.2s ease;
        border-radius: 6px;
        padding: 12px;
        margin: 4px;
        border: 1px solid transparent;
    }
    
    .product-palette-item:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: #06b6d4;
    }
    
    .product-palette-item:active {
        cursor: grabbing;
    }
    
    .product-palette-item.selected {
        border-color: #2563eb;
        background-color: #dbeafe;
        transform: scale(1.02);
    }
    
    .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        opacity: 0;
        background-image: 
            linear-gradient(to right, rgba(6, 182, 212, 0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(6, 182, 212, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        transition: opacity 0.2s ease;
        border-radius: 6px;
    }
    
    .shelf-level:hover .grid-overlay {
        opacity: 1;
    }
    
    .controls-panel {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        margin-top: 16px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
        border-radius: 6px;
        padding: 12px;
        text-align: center;
    }
    
    .operation-guide {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border: 1px solid #93c5fd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
        font-size: 12px;
        color: #1e40af;
    }
    
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .search-result-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s;
    }
    
    .search-result-item:hover {
        background-color: #f9fafb;
    }
    
    .product-image {
        width: 32px;
        height: 32px;
        object-fit: contain;
        border-radius: 4px;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <h2 class="text-primary">
            <i class="fas fa-cube me-2"></i>{{ shelf.name }}
            <small class="text-muted">æ£šå‰²ã‚Šç·¨é›†</small>
        </h2>
        <p class="text-muted">
            ã‚µã‚¤ã‚º: {{ shelf.width }}Ã—{{ shelf.depth }}Ã—{{ shelf.total_height }}cm
            | æ®µæ•°: {{ segments.count }}æ®µ
            | é…ç½®å•†å“: {{ shelf.total_products }}å€‹
        </p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'shelf:segment_edit' shelf.id %}" class="btn btn-outline-primary me-2">
            <i class="fas fa-cogs me-1"></i>æ®µè¨­å®š
        </a>
        <a href="{% url 'shelf:list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>æ£šä¸€è¦§ã«æˆ»ã‚‹
        </a>
    </div>
</div>

<div class="row">
    <!-- å•†å“ãƒ‘ãƒ¬ãƒƒãƒˆ -->
    <div class="col-md-4 order-2 order-md-1">
        <div class="product-palette bg-white">
            <!-- æ¤œç´¢ãƒãƒ¼ -->
            <div class="p-3 border-bottom">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-boxes me-2"></i>å•†å“ãƒ‘ãƒ¬ãƒƒãƒˆ
                </h5>
                <div class="operation-guide">
                    <strong>æ“ä½œæ–¹æ³•:</strong><br>
                    â€¢ å•†å“ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æ£šã«ãƒ‰ãƒ­ãƒƒãƒ—<br>
                    â€¢ ã¾ãŸã¯å•†å“ã‚’ã‚¯ãƒªãƒƒã‚¯â†’æ®µã‚’ã‚¯ãƒªãƒƒã‚¯<br>
                    â€¢ é…ç½®å¾Œã¯ãƒ›ãƒãƒ¼ã§è©³ç´°æ“ä½œ
                </div>
                <div class="position-relative">
                    <input type="text" class="form-control form-control-sm" 
                           id="productSearch" placeholder="å•†å“åã§æ¤œç´¢...">
                    <div class="search-results" id="searchResults" style="display: none;"></div>
                </div>
            </div>
            
            <!-- å•†å“ãƒªã‚¹ãƒˆ -->
            <div class="p-2" id="productList">
                {% for product in products %}
                    <div class="product-palette-item bg-gradient-to-r" 
                         data-product-id="{{ product.id }}"
                         data-product-name="{{ product.name }}"
                         data-product-width="{{ product.width }}"
                         data-product-height="{{ product.height }}"
                         data-product-price="{{ product.price }}"
                         title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é…ç½® ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ"
                         style="background: linear-gradient(135deg, 
                                {% cycle '#fef3c7' '#ddd6fe' '#fce7f3' '#d1fae5' '#fed7d7' '#bfdbfe' %} 0%, 
                                {% cycle '#fde68a' '#c4b5fd' '#f9a8d4' '#a7f3d0' '#fbb6ce' '#93c5fd' %} 100%);">
                        
                        <div class="d-flex align-items-center">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" class="product-image" alt="{{ product.name }}">
                            {% else %}
                                <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-cube text-muted"></i>
                                </div>
                            {% endif %}
                            
                            <div class="flex-grow-1">
                                <div class="fw-bold" style="font-size: 13px;">
                                    {{ product.name|truncatechars:20 }}
                                </div>
                                <div class="text-muted" style="font-size: 11px;">
                                    {{ product.maker|default:"" }}
                                    {% if product.price %}| Â¥{{ product.price }}{% endif %}
                                </div>
                                <div class="text-info" style="font-size: 10px;">
                                    {{ product.width }}Ã—{{ product.height }}cm
                                </div>
                            </div>
                            
                            <div class="text-muted">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- æ£šè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="col-md-8 order-1 order-md-2">
        <div class="bg-white rounded p-4 border">
            <div class="d-flex justify-between align-items-center mb-3">
                <h5 class="text-primary mb-0">
                    <i class="fas fa-th-large me-2"></i>æ£šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success" onclick="saveLayout()">
                        <i class="fas fa-save me-1"></i>ä¿å­˜
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearAllPlacements()">
                        <i class="fas fa-trash me-1"></i>å…¨ã¦ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>
            
            <div class="shelf-container" id="shelfContainer">
                {% for segment in segments %}
                    <div class="shelf-level" 
                         data-segment-id="{{ segment.id }}"
                         data-segment-level="{{ segment.level }}"
                         data-segment-height="{{ segment.height }}"
                         style="height: {{ segment.height|floatformat:0|add:'0' }}px;">
                        
                        <!-- ã‚°ãƒªãƒƒãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                        <div class="grid-overlay"></div>
                        
                        <!-- æ®µãƒ©ãƒ™ãƒ« -->
                        <div class="segment-label">æ®µ{{ segment.level }}</div>
                        
                        <!-- æ®µæƒ…å ± -->
                        <div class="segment-info">
                            {{ segment.height }}cm | ç©ºã: {{ segment.available_width|floatformat:1 }}cm
                        </div>
                        <!-- é…ç½®ã•ã‚ŒãŸå•†å“ -->
                        {% for placement in segment.placements.all %}
                            <div class="product-in-shelf" 
                                data-placement-id="{{ placement.id }}"
                                data-product-id="{{ placement.product.id }}"
                                data-facing="{{ placement.face_count }}"
                                data-product-name="{{ placement.product.name }}"
                                data-product-image="{% if placement.product.image %}{{ placement.product.image.url }}{% endif %}"
                                data-product-width="{{ placement.product.width|display_width }}"
                                style="left: {{ placement|placement_position|floatformat:0 }}px; 
                                        width: {{ placement|placement_width|floatformat:0 }}px;
                                        height: 50px;
                                        top: 5px;">
                                
                                <!-- ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°è¡¨ç¤ºï¼ˆè¤‡æ•°å•†å“ã‚’æ¨ªä¸¦ã³è¡¨ç¤ºï¼‰ -->
                                {% for face_num in placement.face_count|make_list %}
                                    <div class="single-product" style="
                                        position: absolute;
                                        left: {{ forloop.counter0|mul:placement.product.width|display_width|floatformat:0 }}px;
                                        width: {{ placement.product.width|display_width|floatformat:0 }}px;
                                        height: 100%;
                                        border-right: {% if not forloop.last %}1px solid #e5e7eb{% else %}none{% endif %};
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        justify-content: center;
                                        padding: 2px;
                                        background: white;
                                        box-sizing: border-box;
                                    ">
                                        {% if placement.product.image %}
                                            <img src="{{ placement.product.image.url }}" 
                                                alt="{{ placement.product.name }}"
                                                style="width: 90%; height: 90%; object-fit: contain;">
                                        {% else %}
                                            <div style="width: 90%; height: 90%; background: #f3f4f6; border-radius: 4px; 
                                                        display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-cube text-muted" style="font-size: 16px;"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                
                                {% if placement.face_count > 1 %}
                                    <div class="facing-indicator">{{ placement.face_count }}</div>
                                {% endif %}
                                
                                <!-- ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                                <div class="facing-controls">
                                    <button class="facing-btn" onclick="changeFacing('{{ placement.id }}', -1)">-</button>
                                    <span class="px-2 py-1 text-xs bg-white">{{ placement.face_count }}</span>
                                    <button class="facing-btn" onclick="changeFacing('{{ placement.id }}', 1)">+</button>
                                    <button class="remove-product-btn" onclick="removeProduct('{{ placement.id }}')">Ã—</button>
                                </div>
                            </div>
                        {% endfor %}

                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- æ“ä½œãƒ‘ãƒãƒ« -->
        <div class="controls-panel p-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="h6 mb-1">é…ç½®åŠ¹ç‡</div>
                        <div class="h5 mb-0">
                            {% widthratio shelf.total_products 20 100 %}%
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showGrid" checked>
                        <label class="form-check-label" for="showGrid">
                            <i class="fas fa-grip-horizontal me-1"></i>ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
                        </label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="snapToGrid" checked>
                        <label class="form-check-label" for="snapToGrid">
                            <i class="fas fa-magnet me-1"></i>ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒŠãƒƒãƒ—
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// shelf_detail.html ã® JavaScriptéƒ¨åˆ†ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æ–‡ä¿®æ­£ç‰ˆï¼‰

let selectedProduct = null;
let draggedProduct = null;
let products = new Map();
let isDragging = false;

// åº§æ¨™å¤‰æ›ä¿‚æ•°ï¼ˆçµ±ä¸€ï¼‰
const COORD_SCALE = 10; // 1cm = 10px
const DEBUG_MODE = true; // æœ¬ç•ªã§ã¯ false

// Djangoå¤‰æ•°ã‚’JavaScriptå¤‰æ•°ã¨ã—ã¦å®šç¾©
const SHELF_ID = {{ shelf.id }};

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
function debugLog(message, data = null) {
    if (DEBUG_MODE) {
        console.log(`[DEBUG] ${new Date().toLocaleTimeString()} ${message}`, data || '');
    }
}

// åº§æ¨™æ­£è¦åŒ–é–¢æ•°ï¼ˆDecimalç²¾åº¦å¯¾å¿œï¼‰
function normalizeCoordinate(value, precision = 1) {
    const factor = Math.pow(10, precision);
    return Math.round(value * factor) / factor;
}

// åº§æ¨™å¤‰æ›é–¢æ•°
function pxToCm(px) {
    return normalizeCoordinate(px / COORD_SCALE);
}

function cmToPx(cm) {
    return normalizeCoordinate(cm * COORD_SCALE);
}

$(document).ready(function() {
    initializeSystem();
    if (DEBUG_MODE) {
        addDebugPanel();
        addDebugCommands();
    }
});

function initializeSystem() {
    initializeDragAndDrop();
    setupEventHandlers();
    loadExistingProducts();
    debugLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
}

function initializeDragAndDrop() {
    // å•†å“ãƒ‘ãƒ¬ãƒƒãƒˆã®ãƒ‰ãƒ©ãƒƒã‚°è¨­å®š
    $('.product-palette-item').each(function() {
        this.draggable = true;
        
        $(this).on('dragstart', function(e) {
            const productData = {
                id: $(this).data('product-id'),
                name: $(this).data('product-name'),
                width: parseFloat($(this).data('product-width')),
                height: parseFloat($(this).data('product-height')),
                price: $(this).data('product-price')
            };
            
            draggedProduct = productData;
            e.originalEvent.dataTransfer.effectAllowed = 'copy';
            e.originalEvent.dataTransfer.setData('text/plain', '');
            
            debugLog('ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹', productData);
            highlightCompatibleSegments(productData.height);
        });
        
        $(this).on('dragend', function(e) {
            draggedProduct = null;
            $('.shelf-level').removeClass('drop-available drop-unavailable');
            debugLog('ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†');
        });
    });
    
    // æ£šæ®µã®ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
    $('.shelf-level').each(function() {
        const segment = this;
        const segmentHeight = $(segment).data('segment-height');
        
        $(segment).on('dragover', function(e) {
            e.preventDefault();
            e.originalEvent.dataTransfer.dropEffect = 'copy';
            $(this).addClass('drag-over');
        });
        
        $(segment).on('dragleave', function(e) {
            if (!segment.contains(e.relatedTarget)) {
                $(this).removeClass('drag-over');
            }
        });
        
        $(segment).on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
            
            if (draggedProduct) {
                const rect = segment.getBoundingClientRect();
                const displayX = e.originalEvent.clientX - rect.left;
                const displayY = e.originalEvent.clientY - rect.top;
                
                // ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒŠãƒƒãƒ—é©ç”¨
                const gridX = $('#snapToGrid').is(':checked') ? 
                    Math.round(displayX / 20) * 20 : displayX;
                const gridY = Math.max(10, Math.min(displayY, rect.height - 50));
                
                debugLog('ãƒ‰ãƒ­ãƒƒãƒ—åº§æ¨™', {
                    originalX: displayX,
                    gridX: gridX,
                    realX: pxToCm(gridX)
                });
                
                addProductToShelf(segment, draggedProduct, gridX, gridY);
                draggedProduct = null;
            }
        });
        
        // ã‚¯ãƒªãƒƒã‚¯é…ç½®
        $(segment).on('click', function(e) {
            if (selectedProduct && !isDragging) {
                const rect = segment.getBoundingClientRect();
                const displayX = e.clientX - rect.left;
                const displayY = e.clientY - rect.top;
                
                const gridX = $('#snapToGrid').is(':checked') ? 
                    Math.round(displayX / 20) * 20 : displayX;
                const gridY = Math.max(10, Math.min(displayY, rect.height - 50));
                
                debugLog('ã‚¯ãƒªãƒƒã‚¯é…ç½®', {
                    product: selectedProduct.name,
                    displayX: gridX,
                    realX: pxToCm(gridX)
                });
                
                addProductToShelf(segment, selectedProduct, gridX, gridY);
                deselectProduct();
            }
        });
    });
}

function addProductToShelf(shelfLevel, product, displayX, displayY) {
    const segmentId = $(shelfLevel).data('segment-id');
    const normalizedX = normalizeCoordinate(displayX);
    const realX = pxToCm(normalizedX);
    
    // å•†å“ã®è¡¨ç¤ºã‚µã‚¤ã‚ºè¨ˆç®—ï¼ˆçµ±ä¸€ï¼‰
    const productDisplayWidth = cmToPx(product.width);
    const productDisplayHeight = Math.min(cmToPx(product.height * 0.8), 50);
    
    debugLog('å•†å“é…ç½®é–‹å§‹', {
        product: product.name,
        segment: segmentId,
        displayX: normalizedX,
        realX: realX,
        productWidth: product.width,
        displayWidth: productDisplayWidth
    });
    
    // ã‚µãƒ¼ãƒãƒ¼ã«é…ç½®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    $.ajax({
        url: "{% url 'shelf:place_product_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            shelf_id: SHELF_ID,
            segment_id: segmentId,
            product_id: product.id,
            x_position: realX,
            face_count: 1
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                showMessage('å•†å“ã‚’é…ç½®ã—ã¾ã—ãŸ', 'success');
                
                // æ­£ç¢ºãªä½ç½®ã§UIè¦ç´ ã‚’ä½œæˆ
                const finalDisplayX = cmToPx(response.debug_info.x_position);
                createProductElement(
                    shelfLevel, 
                    product, 
                    finalDisplayX, 
                    displayY, 
                    productDisplayWidth, 
                    productDisplayHeight, 
                    response.placement_id
                );
                
                debugLog('é…ç½®æˆåŠŸ', response.debug_info);
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('é…ç½®å¤±æ•—', response);
            }
        },
        error: function(xhr, status, error) {
            debugLog('é…ç½®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', error);
            showMessage('é…ç½®ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    });
}

function createProductElement(shelfLevel, product, displayX, displayY, width, height, placementId) {
    const productElement = $(`
        <div class="product-in-shelf" 
             data-placement-id="${placementId}"
             data-product-id="${product.id}"
             data-facing="1"
             data-product-width="${width}"
             style="left: ${displayX}px; top: ${displayY}px; width: ${width}px; height: ${height}px;">
            
            <div class="single-product" style="
                position: absolute;
                left: 0px;
                width: ${width}px;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2px;
                background: white;
                border-radius: 4px;
            ">
                <div class="product-info">
                    <div class="product-name">${product.name.substring(0, 12)}</div>
                    ${product.price ? `<div class="product-price">Â¥${product.price}</div>` : ''}
                </div>
            </div>
            
            <div class="facing-controls">
                <button class="facing-btn" onclick="changeFacing('${placementId}', -1)">-</button>
                <span class="px-2 py-1 text-xs bg-white">1</span>
                <button class="facing-btn" onclick="changeFacing('${placementId}', 1)">+</button>
                <button class="remove-product-btn" onclick="removeProduct('${placementId}')">Ã—</button>
            </div>
        </div>
    `);
    
    // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•æ©Ÿèƒ½ã‚’è¿½åŠ 
    setupProductDragging(productElement, placementId);
    
    $(shelfLevel).append(productElement);
    
    debugLog('UIè¦ç´ ä½œæˆ', {
        placementId: placementId,
        displayX: displayX,
        width: width,
        height: height
    });
}

function setupProductDragging(productElement, placementId) {
    productElement.on('mousedown', function(e) {
        if ($(e.target).closest('.facing-controls').length > 0) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        const startDisplayX = normalizeCoordinate(parseInt($(productElement).css('left')) || 0);
        const startMouseX = e.clientX;
        let originalShelfLevel = $(productElement).closest('.shelf-level');
        let currentShelfLevel = originalShelfLevel;
        
        $(productElement).addClass('dragging');
        $('.shelf-level').addClass('drop-target-available');
        
        debugLog('å•†å“ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹', {
            placementId: placementId,
            startDisplayX: startDisplayX,
            startRealX: pxToCm(startDisplayX)
        });
        
        const mouseMoveHandler = function(e) {
            const deltaX = e.clientX - startMouseX;
            const newDisplayX = normalizeCoordinate(startDisplayX + deltaX);
            
            // æ®µã®å¤‰æ›´æ¤œå‡º
            const elementsAtPoint = document.elementsFromPoint(e.clientX, e.clientY);
            let targetShelfLevel = null;
            
            for (let el of elementsAtPoint) {
                if ($(el).hasClass('shelf-level')) {
                    targetShelfLevel = $(el);
                    break;
                }
            }
            
            if (targetShelfLevel && targetShelfLevel[0] !== currentShelfLevel[0]) {
                currentShelfLevel.removeClass('drag-over-segment');
                currentShelfLevel = targetShelfLevel;
                currentShelfLevel.addClass('drag-over-segment');
                $(productElement).appendTo(currentShelfLevel);
            }
            
            // Xè»¸ä½ç½®åˆ¶ç´„
            const currentWidth = parseInt($(productElement).css('width'));
            const shelfWidth = currentShelfLevel.width();
            
            const gridX = $('#snapToGrid').is(':checked') ? 
                Math.round(newDisplayX / 20) * 20 : newDisplayX;
            const constrainedX = Math.max(0, Math.min(gridX, shelfWidth - currentWidth));
            
            // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚£ãƒƒãƒˆï¼ˆä»–ã®å•†å“ã¨ã®å¸ç€ï¼‰
            const finalX = applySmartFit(constrainedX, currentWidth, currentShelfLevel, productElement);
            
            $(productElement).css({
                left: finalX + 'px',
                top: '5px'
            });
        };
        
        const mouseUpHandler = function() {
            $(productElement).removeClass('dragging snapping');
            $('.shelf-level').removeClass('drop-target-available drag-over-segment');
            $(document).off('mousemove', mouseMoveHandler);
            $(document).off('mouseup', mouseUpHandler);
            
            // æœ€çµ‚ä½ç½®ã§ã®æ›´æ–°
            const finalDisplayX = normalizeCoordinate(parseInt($(productElement).css('left')));
            const finalRealX = pxToCm(finalDisplayX);
            const finalSegmentId = currentShelfLevel.data('segment-id');
            const originalSegmentId = originalShelfLevel.data('segment-id');
            
            debugLog('ãƒ‰ãƒ©ãƒƒã‚°å®Œäº†', {
                placementId: placementId,
                originalSegment: originalSegmentId,
                finalSegment: finalSegmentId,
                finalDisplayX: finalDisplayX,
                finalRealX: finalRealX
            });
            
            // ã‚µãƒ¼ãƒãƒ¼ã«æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if (finalSegmentId !== originalSegmentId) {
                // æ®µé–“ç§»å‹•
                moveProductBetweenSegments(placementId, finalSegmentId, finalRealX);
            } else {
                // åŒä¸€æ®µå†…ç§»å‹•
                updateProductPosition(placementId, finalRealX);
            }
            
            setTimeout(() => { isDragging = false; }, 100);
        };
        
        $(document).on('mousemove', mouseMoveHandler);
        $(document).on('mouseup', mouseUpHandler);
    });
}

function applySmartFit(constrainedX, currentWidth, currentShelfLevel, excludeElement) {
    const nearbyProducts = currentShelfLevel.find('.product-in-shelf').not(excludeElement);
    let finalX = constrainedX;
    const snapDistance = 40;
    let isSnapping = false;
    
    nearbyProducts.each(function() {
        const otherX = parseInt($(this).css('left'));
        const otherWidth = parseInt($(this).css('width'));
        
        // å³ç«¯å¸ç€
        const rightSnapDistance = Math.abs(constrainedX - (otherX + otherWidth));
        if (rightSnapDistance < snapDistance) {
            finalX = otherX + otherWidth;
            isSnapping = true;
            return false;
        }
        
        // å·¦ç«¯å¸ç€
        const leftSnapDistance = Math.abs((constrainedX + currentWidth) - otherX);
        if (leftSnapDistance < snapDistance) {
            finalX = otherX - currentWidth;
            isSnapping = true;
            return false;
        }
    });
    
    if (isSnapping) {
        $(excludeElement).addClass('snapping');
    } else {
        $(excludeElement).removeClass('snapping');
    }
    
    return finalX;
}

function moveProductBetweenSegments(placementId, newSegmentId, newRealX) {
    debugLog('æ®µé–“ç§»å‹•ãƒªã‚¯ã‚¨ã‚¹ãƒˆ', {
        placementId: placementId,
        newSegmentId: newSegmentId,
        newRealX: newRealX
    });
    
    $.ajax({
        url: "{% url 'shelf:update_placement_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            placement_id: placementId,
            segment_id: newSegmentId,
            x_position: newRealX
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                showMessage('å•†å“ã‚’ä»–ã®æ®µã«ç§»å‹•ã—ã¾ã—ãŸ', 'success');
                debugLog('æ®µé–“ç§»å‹•æˆåŠŸ', response.debug_info);
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('æ®µé–“ç§»å‹•å¤±æ•—', response);
                location.reload();
            }
        },
        error: function(xhr, status, error) {
            debugLog('æ®µé–“ç§»å‹•ã‚¨ãƒ©ãƒ¼', error);
            showMessage('æ®µé–“ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            location.reload();
        }
    });
}

function updateProductPosition(placementId, newRealX) {
    debugLog('ä½ç½®æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ', {
        placementId: placementId,
        newRealX: newRealX
    });
    
    $.ajax({
        url: "{% url 'shelf:update_placement_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            placement_id: placementId,
            x_position: newRealX
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                debugLog('ä½ç½®æ›´æ–°æˆåŠŸ', response.debug_info);
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('ä½ç½®æ›´æ–°å¤±æ•—', response);
                location.reload();
            }
        },
        error: function(xhr, status, error) {
            debugLog('ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼', error);
            showMessage('ä½ç½®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    });
}

function changeFacing(placementId, change) {
    debugLog('ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´', {
        placementId: placementId,
        change: change
    });
    
    $.ajax({
        url: "{% url 'shelf:update_placement_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            placement_id: placementId,
            face_count_change: change
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                updateProductFacing(placementId, response.new_face_count);
                showMessage(`ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°ã‚’${response.new_face_count}å€‹ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
                debugLog('ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´æˆåŠŸ', response.debug_info);
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´å¤±æ•—', response);
            }
        },
        error: function(xhr, status, error) {
            debugLog('ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´ã‚¨ãƒ©ãƒ¼', error);
            showMessage('ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    });
}

function updateProductFacing(placementId, newFacing) {
    const element = $(`.product-in-shelf[data-placement-id="${placementId}"]`);
    if (element.length === 0) return;
    
    const productWidth = parseFloat(element.data('product-width'));
    const totalWidth = productWidth * newFacing;
    
    // è¦ç´ ã®ã‚µã‚¤ã‚ºã¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    element.data('facing', newFacing);
    element.css('width', totalWidth + 'px');
    element.find('.facing-controls span').text(newFacing);
    
    // ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°
    if (newFacing > 1) {
        if (element.find('.facing-indicator').length === 0) {
            element.append(`<div class="facing-indicator">${newFacing}</div>`);
        } else {
            element.find('.facing-indicator').text(newFacing);
        }
    } else {
        element.find('.facing-indicator').remove();
    }
    
    // å•†å“è¡¨ç¤ºã®å†æ§‹ç¯‰
    element.find('.single-product').remove();
    
    for (let i = 0; i < newFacing; i++) {
        const singleProduct = $(`
            <div class="single-product" style="
                position: absolute;
                left: ${i * productWidth}px;
                width: ${productWidth}px;
                height: 100%;
                border-right: ${i < newFacing - 1 ? '1px solid #e5e7eb' : 'none'};
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2px;
                background: white;
                box-sizing: border-box;
            ">
                <div class="product-info">
                    <div class="product-name">å•†å“</div>
                </div>
            </div>
        `);
        element.prepend(singleProduct);
    }
    
    debugLog('ãƒ•ã‚§ãƒ¼ã‚·ãƒ³ã‚°è¡¨ç¤ºæ›´æ–°', {
        placementId: placementId,
        newFacing: newFacing,
        totalWidth: totalWidth
    });
}

function removeProduct(placementId) {
    if (!confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    debugLog('å•†å“å‰Šé™¤', { placementId: placementId });
    
    $.ajax({
        url: "{% url 'shelf:delete_placement_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            placement_id: placementId
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                $(`.product-in-shelf[data-placement-id="${placementId}"]`).remove();
                showMessage('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                debugLog('å‰Šé™¤æˆåŠŸ');
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('å‰Šé™¤å¤±æ•—', response);
            }
        },
        error: function(xhr, status, error) {
            debugLog('å‰Šé™¤ã‚¨ãƒ©ãƒ¼', error);
            showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    });
}

function setupEventHandlers() {
    // å•†å“é¸æŠ
    $('.product-palette-item').on('click', function(e) {
        if (e.which === 1) {
            selectProduct(this);
        }
    });
    
    // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºåˆ‡æ›¿
    $('#showGrid').on('change', function() {
        const show = $(this).is(':checked');
        if (show) {
            $('.grid-overlay').css('opacity', '0');
            $('.shelf-level:hover .grid-overlay').css('opacity', '1');
        } else {
            $('.grid-overlay').css('opacity', '0');
        }
    });
    
    // å•†å“æ¤œç´¢
    let searchTimeout;
    $('#productSearch').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val().trim();
        
        if (query.length < 2) {
            $('#searchResults').hide();
            return;
        }
        
        searchTimeout = setTimeout(() => searchProducts(query), 300);
    });
}

function loadExistingProducts() {
    $('.product-in-shelf').each(function() {
        const element = this;
        const placementId = $(element).data('placement-id');
        const currentFacing = parseInt($(element).data('facing')) || 1;
        
        // å•†å“ã®åŸºæœ¬å¹…ã‚’è¨ˆç®—
        const currentWidth = parseFloat($(element).css('width'));
        const productWidth = currentWidth / currentFacing;
        $(element).data('product-width', productWidth);
        
        debugLog('æ—¢å­˜å•†å“èª­ã¿è¾¼ã¿', {
            placementId: placementId,
            facing: currentFacing,
            totalWidth: currentWidth,
            productWidth: productWidth
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¨­å®š
        setupProductDragging($(element), placementId);
    });
}

// ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function selectProduct(element) {
    $('.product-palette-item').removeClass('selected');
    $(element).addClass('selected');
    
    selectedProduct = {
        id: $(element).data('product-id'),
        name: $(element).data('product-name'),
        width: parseFloat($(element).data('product-width')),
        height: parseFloat($(element).data('product-height')),
        price: $(element).data('product-price')
    };
    
    highlightCompatibleSegments(selectedProduct.height);
    showMessage(`å•†å“ã€Œ${selectedProduct.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`, 'info');
    debugLog('å•†å“é¸æŠ', selectedProduct);
}

function deselectProduct() {
    selectedProduct = null;
    $('.product-palette-item').removeClass('selected');
    $('.shelf-level').removeClass('drop-available drop-unavailable');
    debugLog('å•†å“é¸æŠè§£é™¤');
}

function highlightCompatibleSegments(productHeight) {
    $('.shelf-level').each(function() {
        const segmentHeight = $(this).data('segment-height');
        if (productHeight <= segmentHeight) {
            $(this).addClass('drop-available');
        } else {
            $(this).addClass('drop-unavailable');
        }
    });
}

function clearAllPlacements() {
    if (!confirm('ã™ã¹ã¦ã®å•†å“é…ç½®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
    }
    
    debugLog('å…¨é…ç½®å‰Šé™¤é–‹å§‹');
    
    $.ajax({
        url: "{% url 'shelf:clear_all_placements_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            shelf_id: SHELF_ID
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                $('.product-in-shelf').remove();
                showMessage(response.message, 'success');
                debugLog('å…¨é…ç½®å‰Šé™¤æˆåŠŸ');
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('å…¨é…ç½®å‰Šé™¤å¤±æ•—', response);
            }
        },
        error: function(xhr, status, error) {
            debugLog('å…¨é…ç½®å‰Šé™¤ã‚¨ãƒ©ãƒ¼', error);
            showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    });
}

function saveLayout() {
    showMessage('ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    debugLog('ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿å­˜');
}

function searchProducts(query) {
    $.ajax({
        url: "{% url 'shelf:product_search_ajax' %}",
        data: { q: query },
        success: function(response) {
            displaySearchResults(response.products);
        }
    });
}

function displaySearchResults(products) {
    const resultsDiv = $('#searchResults');
    resultsDiv.empty();
    
    if (products.length === 0) {
        resultsDiv.html('<div class="search-result-item text-muted">è©²å½“ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>');
    } else {
        products.forEach(function(product) {
            const item = $(`
                <div class="search-result-item" data-product-id="${product.id}">
                    <div class="fw-bold">${product.name}</div>
                    <div class="text-muted small">${product.maker || ''} | ${product.width}Ã—${product.height}cm</div>
                </div>
            `);
            
            item.on('click', function() {
                const paletteItem = $(`.product-palette-item[data-product-id="${product.id}"]`);
                if (paletteItem.length) {
                    selectProduct(paletteItem[0]);
                    paletteItem[0].scrollIntoView({ behavior: 'smooth' });
                }
                resultsDiv.hide();
                $('#productSearch').val('');
            });
            
            resultsDiv.append(item);
        });
    }
    
    resultsDiv.show();
}

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    setTimeout(() => {
        $('.alert').fadeOut(() => {
            $('.alert').remove();
        });
    }, 3000);
}

// ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
function addDebugPanel() {
    const debugPanel = $(`
        <div id="debugPanel" style="
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            z-index: 9999;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #444;
        ">
            <div style="border-bottom: 1px solid #666; margin-bottom: 10px; padding-bottom: 5px;">
                <strong style="color: #4CAF50;">ğŸ”§ DEBUG PANEL</strong>
                <button onclick="$('#debugPanel').toggle()" style="float: right; background: none; border: none; color: white;">Ã—</button>
            </div>
            <div id="debugContent">
                <div>åº§æ¨™å¤‰æ›ä¿‚æ•°: ${COORD_SCALE}</div>
                <div>ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${DEBUG_MODE ? 'ON' : 'OFF'}</div>
                <div>æ£šID: ${SHELF_ID}</div>
                <div>åˆæœŸåŒ–å®Œäº†</div>
            </div>
        </div>
    `);
    
    $('body').append(debugPanel);
}

function updateDebugInfo() {
    if (!DEBUG_MODE) return;
    
    const debugContent = $('#debugContent');
    if (debugContent.length === 0) return;
    
    let content = `
        <div>åº§æ¨™å¤‰æ›ä¿‚æ•°: ${COORD_SCALE}</div>
        <div>æ£šID: ${SHELF_ID}</div>
        <div>é¸æŠå•†å“: ${selectedProduct ? selectedProduct.name : 'ãªã—'}</div>
        <div>ãƒ‰ãƒ©ãƒƒã‚°ä¸­: ${isDragging ? 'Yes' : 'No'}</div>
        <div>é…ç½®å•†å“æ•°: ${$('.product-in-shelf').length}</div>
        <div style="border-top: 1px solid #666; margin-top: 5px; padding-top: 5px;">é…ç½®è©³ç´°:</div>
    `;
    
    $('.product-in-shelf').each(function(index) {
        const placementId = $(this).data('placement-id');
        const facing = $(this).data('facing');
        const displayX = parseInt($(this).css('left'));
        const realX = pxToCm(displayX);
        const width = parseInt($(this).css('width'));
        
        content += `<div style="font-size: 10px; color: #ccc;">ID:${placementId} X:${realX}cm (${displayX}px) å¹…:${width}px F:${facing}</div>`;
    });
    
    debugContent.html(content);
}

function addDebugCommands() {
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ 
    window.debugShelf = {
        showCoordinates: function() {
            $('.product-in-shelf').each(function() {
                const id = $(this).data('placement-id');
                const x = parseInt($(this).css('left'));
                const realX = pxToCm(x);
                console.log(`Placement ${id}: Display=${x}px, Real=${realX}cm`);
            });
        },
        
        validatePositions: function() {
            // ãƒ‡ãƒãƒƒã‚°URLæ§‹ç¯‰ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
            const debugUrl = `/shelf/debug/${SHELF_ID}/`;
            $.get(debugUrl, function(data) {
                console.log('Server data:', data);
            }).fail(function(xhr, status, error) {
                console.error('Debug API Error:', error);
                console.log('Debug URL was:', debugUrl);
            });
        },
        
        resetCoordinates: function() {
            $('.product-in-shelf').each(function() {
                const currentX = parseInt($(this).css('left'));
                const normalizedX = normalizeCoordinate(currentX);
                $(this).css('left', normalizedX + 'px');
            });
            console.log('åº§æ¨™ã‚’æ­£è¦åŒ–ã—ã¾ã—ãŸ');
            updateDebugInfo();
        },
        
        info: function() {
            console.log('=== SHELF DEBUG INFO ===');
            console.log('Shelf ID:', SHELF_ID);
            console.log('Coordinate Scale:', COORD_SCALE);
            console.log('Debug Mode:', DEBUG_MODE);
            console.log('Products on shelf:', $('.product-in-shelf').length);
            console.log('Selected product:', selectedProduct);
            console.log('========================');
        }
    };
    
    console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰åˆ©ç”¨å¯èƒ½:');
    console.log('- debugShelf.info() : ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±');
    console.log('- debugShelf.showCoordinates() : åº§æ¨™è¡¨ç¤º');
    console.log('- debugShelf.validatePositions() : ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒ');
    console.log('- debugShelf.resetCoordinates() : åº§æ¨™æ­£è¦åŒ–');
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
$(document).on('keydown', function(e) {
    if (e.key === 'Escape') {
        deselectProduct();
    }
});

$(document).on('click', function(e) {
    if (!$(e.target).closest('#productSearch, #searchResults').length) {
        $('#searchResults').hide();
    }
});

// è¡¨ç¤ºå¹…è¨ˆç®—ã®çµ±ä¸€ç¢ºèª
function verifyDisplayWidth() {
    console.log('=== è¡¨ç¤ºå¹…çµ±ä¸€ç¢ºèª ===');
    
    $('.product-in-shelf').each(function() {
        const placementId = $(this).data('placement-id');
        const facing = parseInt($(this).data('facing')) || 1;
        const productWidthData = parseFloat($(this).data('product-width'));
        const currentDisplayWidth = parseInt($(this).css('width'));
        
        // ç†è«–å€¤è¨ˆç®—ï¼ˆå•†å“å¹…ã®ãƒ”ã‚¯ã‚»ãƒ«å€¤ Ã— ãƒ•ã‚§ãƒ¼ã‚¹æ•°ï¼‰
        const productWidthCm = productWidthData / 10; // data-product-widthã¯pxå€¤
        const expectedDisplayWidth = productWidthCm * 10 * facing; // cm * 10 * ãƒ•ã‚§ãƒ¼ã‚¹æ•°
        
        const isMatch = Math.abs(currentDisplayWidth - expectedDisplayWidth) < 1;
        
        console.log(`Placement ${placementId}:`, {
            facing: facing,
            productWidthCm: productWidthCm,
            expected: expectedDisplayWidth,
            actual: currentDisplayWidth,
            match: isMatch ? 'âœ…' : 'âŒ'
        });
        
        if (!isMatch) {
            console.warn(`âš ï¸ è¡¨ç¤ºå¹…ä¸æ•´åˆ: Placement ${placementId}`);
        }
    });
}

// ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰ã«è¿½åŠ 
if (typeof window.debugShelf !== 'undefined') {
    window.debugShelf.verifyDisplayWidth = verifyDisplayWidth;
    console.log('- debugShelf.verifyDisplayWidth() : è¡¨ç¤ºå¹…æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯');
}

// å®šæœŸçš„ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
if (DEBUG_MODE) {
    setInterval(updateDebugInfo, 2000);
}
</script>
{% endblock %}