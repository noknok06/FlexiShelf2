<!-- shelf/templates/shelf/shelf_detail.html -->

{% extends 'shelf/base.html' %}
{% load shelf_extras %}

{% block title %}{{ title }} - 棚割りシステム{% endblock %}

{% block extra_css %}
<style>
    .shelf-container {
        position: relative;
        margin-left: 20px;
    }
    
    .shelf-level {
        position: relative;
        background: linear-gradient(to right, #f8fafc 0%, #f1f5f9 100%);
        border: 2px solid #e2e8f0;
        height: 60px; /* 固定高さ */
        border-radius: 8px;
        margin-bottom: 8px;
        padding: 4px;
        transition: all 0.2s ease;
        cursor: crosshair;
        display: flex;
        align-items: center; /* 商品をY軸中央に配置 */
    }
    
    .shelf-level:hover {
        border-color: #06b6d4;
        box-shadow: 0 4px 8px rgba(6, 182, 212, 0.1);
    }
    
    .shelf-level.drag-over {
        background: linear-gradient(to right, #ecfdf5 0%, #d1fae5 100%);
        border-color: #10b981;
        border-style: dashed;
    }
    
    .shelf-level.drop-available {
        background: linear-gradient(to right, #f0fdf4 0%, #dcfce7 100%);
        border-color: #22c55e;
        border-style: dashed;
    }
    
    .shelf-level.drop-unavailable {
        background: linear-gradient(to right, #fef2f2 0%, #fee2e2 100%);
        border-color: #ef4444;
        border-style: dashed;
        cursor: not-allowed;
    }
    
    .segment-label {
        position: absolute;
        left: -15px;
        top: 50%;
        transform: translateY(-50%);
        background: #1e293b;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        z-index: 2;
    }
    
    .segment-info {
        position: absolute;
        top: 4px;
        right: 8px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        z-index: 3;
    }
    
    .product-in-shelf {
        position: absolute;
        cursor: move;
        transition: all 0.2s ease;
        border: 2px solid #06b6d4;
        border-radius: 6px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2px;
        z-index: 5;
        height: 50px; /* 固定高さ */
        top: 5px; /* 固定Y座標 */
    }
    
    .product-in-shelf:hover {
        border-color: #0891b2;
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        z-index: 10;
        transform: scale(1.02);
    }
    
    .product-in-shelf.dragging {
        opacity: 0.7;
        transform: rotate(2deg) scale(1.05);
        z-index: 20;
        border-color: #f59e0b;
    }
    
    .product-info {
        text-align: center;
        font-size: 8px;
        line-height: 1.2;
    }
    
    .product-name {
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 1px;
    }
    
    .product-price {
        color: #6b7280;
        font-size: 7px;
    }
    
    .facing-indicator {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #dc2626;
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: bold;
        z-index: 6;
    }
    
    .facing-controls {
        position: absolute;
        top: -8px;
        right: 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        display: none;
        z-index: 15;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .product-in-shelf:hover .facing-controls {
        display: flex;
    }
    
    .facing-btn {
        padding: 2px 6px;
        font-size: 10px;
        background: #f9fafb;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .facing-btn:hover {
        background: #e5e7eb;
    }
    
    .remove-product-btn {
        padding: 2px 6px;
        font-size: 10px;
        background: #fee2e2;
        color: #dc2626;
        border: none;
        cursor: pointer;
        margin-left: 2px;
        transition: background-color 0.2s;
    }
    
    .remove-product-btn:hover {
        background: #fecaca;
    }
    
    .product-palette {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    
    .product-palette-item {
        cursor: grab;
        transition: all 0.2s ease;
        border-radius: 6px;
        padding: 12px;
        margin: 4px;
        border: 1px solid transparent;
    }
    
    .product-palette-item:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: #06b6d4;
    }
    
    .product-palette-item:active {
        cursor: grabbing;
    }
    
    .product-palette-item.selected {
        border-color: #2563eb;
        background-color: #dbeafe;
        transform: scale(1.02);
    }
    
    .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        opacity: 0;
        background-image: 
            linear-gradient(to right, rgba(6, 182, 212, 0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(6, 182, 212, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        transition: opacity 0.2s ease;
        border-radius: 6px;
    }
    
    .shelf-level:hover .grid-overlay {
        opacity: 1;
    }
    
    .controls-panel {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        margin-top: 16px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
        border-radius: 6px;
        padding: 12px;
        text-align: center;
    }
    
    .operation-guide {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border: 1px solid #93c5fd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
        font-size: 12px;
        color: #1e40af;
    }
    
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .search-result-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s;
    }
    
    .search-result-item:hover {
        background-color: #f9fafb;
    }
    
    .product-image {
        width: 32px;
        height: 32px;
        object-fit: contain;
        border-radius: 4px;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <h2 class="text-primary">
            <i class="fas fa-cube me-2"></i>{{ shelf.name }}
            <small class="text-muted">棚割り編集</small>
        </h2>
        <p class="text-muted">
            サイズ: {{ shelf.width }}×{{ shelf.depth }}×{{ shelf.total_height }}cm
            | 段数: {{ segments.count }}段
            | 配置商品: {{ shelf.total_products }}個
        </p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'shelf:segment_edit' shelf.id %}" class="btn btn-outline-primary me-2">
            <i class="fas fa-cogs me-1"></i>段設定
        </a>
        <a href="{% url 'shelf:list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>棚一覧に戻る
        </a>
    </div>
</div>

<div class="row">
    <!-- 商品パレット -->
    <div class="col-md-4 order-2 order-md-1">
        <div class="product-palette bg-white">
            <!-- 検索バー -->
            <div class="p-3 border-bottom">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-boxes me-2"></i>商品パレット
                </h5>
                <div class="operation-guide">
                    <strong>操作方法:</strong><br>
                    • 商品をドラッグして棚にドロップ<br>
                    • または商品をクリック→段をクリック<br>
                    • 配置後はホバーで詳細操作
                </div>
                <div class="position-relative">
                    <input type="text" class="form-control form-control-sm" 
                           id="productSearch" placeholder="商品名で検索...">
                    <div class="search-results" id="searchResults" style="display: none;"></div>
                </div>
            </div>
            
            <!-- 商品リスト -->
            <div class="p-2" id="productList">
                {% for product in products %}
                    <div class="product-palette-item bg-gradient-to-r" 
                         data-product-id="{{ product.id }}"
                         data-product-name="{{ product.name }}"
                         data-product-width="{{ product.width }}"
                         data-product-height="{{ product.height }}"
                         data-product-price="{{ product.price }}"
                         title="ドラッグして配置 または クリックで選択"
                         style="background: linear-gradient(135deg, 
                                {% cycle '#fef3c7' '#ddd6fe' '#fce7f3' '#d1fae5' '#fed7d7' '#bfdbfe' %} 0%, 
                                {% cycle '#fde68a' '#c4b5fd' '#f9a8d4' '#a7f3d0' '#fbb6ce' '#93c5fd' %} 100%);">
                        
                        <div class="d-flex align-items-center">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" class="product-image" alt="{{ product.name }}">
                            {% else %}
                                <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-cube text-muted"></i>
                                </div>
                            {% endif %}
                            
                            <div class="flex-grow-1">
                                <div class="fw-bold" style="font-size: 13px;">
                                    {{ product.name|truncatechars:20 }}
                                </div>
                                <div class="text-muted" style="font-size: 11px;">
                                    {{ product.maker|default:"" }}
                                    {% if product.price %}| ¥{{ product.price }}{% endif %}
                                </div>
                                <div class="text-info" style="font-size: 10px;">
                                    {{ product.width }}×{{ product.height }}cm
                                </div>
                            </div>
                            
                            <div class="text-muted">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- 棚表示エリア -->
    <div class="col-md-8 order-1 order-md-2">
        <div class="bg-white rounded p-4 border">
            <div class="d-flex justify-between align-items-center mb-3">
                <h5 class="text-primary mb-0">
                    <i class="fas fa-th-large me-2"></i>棚レイアウト
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success" onclick="saveLayout()">
                        <i class="fas fa-save me-1"></i>保存
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearAllPlacements()">
                        <i class="fas fa-trash me-1"></i>全てクリア
                    </button>
                </div>
            </div>
            
            <div class="shelf-container" id="shelfContainer">
                {% for segment in segments %}
                    <div class="shelf-level" 
                         data-segment-id="{{ segment.id }}"
                         data-segment-level="{{ segment.level }}"
                         data-segment-height="{{ segment.height }}"
                         style="height: {{ segment.height|floatformat:0|add:'0' }}px;">
                        
                        <!-- グリッドオーバーレイ -->
                        <div class="grid-overlay"></div>
                        
                        <!-- 段ラベル -->
                        <div class="segment-label">段{{ segment.level }}</div>
                        
                        <!-- 段情報 -->
                        <div class="segment-info">
                            {{ segment.height }}cm | 空き: {{ segment.available_width|floatformat:1 }}cm
                        </div>
                        <!-- 配置された商品 -->
                        {% for placement in segment.placements.all %}
                            <div class="product-in-shelf" 
                                data-placement-id="{{ placement.id }}"
                                data-product-id="{{ placement.product.id }}"
                                data-facing="{{ placement.face_count }}"
                                data-product-name="{{ placement.product.name }}"
                                data-product-image="{% if placement.product.image %}{{ placement.product.image.url }}{% endif %}"
                                data-product-width="{{ placement.product.width|display_width }}"
                                style="left: {{ placement|placement_position|floatformat:0 }}px; 
                                        width: {{ placement|placement_width|floatformat:0 }}px;
                                        height: 50px;
                                        top: 5px;">
                                
                                <!-- フェーシング表示（複数商品を横並び表示） -->
                                {% for face_num in placement.face_count|make_list %}
                                    <div class="single-product" style="
                                        position: absolute;
                                        left: {{ forloop.counter0|mul:placement.product.width|display_width|floatformat:0 }}px;
                                        width: {{ placement.product.width|display_width|floatformat:0 }}px;
                                        height: 100%;
                                        border-right: {% if not forloop.last %}1px solid #e5e7eb{% else %}none{% endif %};
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        justify-content: center;
                                        padding: 2px;
                                        background: white;
                                        box-sizing: border-box;
                                    ">
                                        {% if placement.product.image %}
                                            <img src="{{ placement.product.image.url }}" 
                                                alt="{{ placement.product.name }}"
                                                style="width: 90%; height: 90%; object-fit: contain;">
                                        {% else %}
                                            <div style="width: 90%; height: 90%; background: #f3f4f6; border-radius: 4px; 
                                                        display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-cube text-muted" style="font-size: 16px;"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                
                                {% if placement.face_count > 1 %}
                                    <div class="facing-indicator">{{ placement.face_count }}</div>
                                {% endif %}
                                
                                <!-- フェーシングコントロール -->
                                <div class="facing-controls">
                                    <button class="facing-btn" onclick="changeFacing('{{ placement.id }}', -1)">-</button>
                                    <span class="px-2 py-1 text-xs bg-white">{{ placement.face_count }}</span>
                                    <button class="facing-btn" onclick="changeFacing('{{ placement.id }}', 1)">+</button>
                                    <button class="remove-product-btn" onclick="removeProduct('{{ placement.id }}')">×</button>
                                </div>
                            </div>
                        {% endfor %}

                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- 操作パネル -->
        <div class="controls-panel p-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="h6 mb-1">配置効率</div>
                        <div class="h5 mb-0">
                            {% widthratio shelf.total_products 20 100 %}%
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showGrid" checked>
                        <label class="form-check-label" for="showGrid">
                            <i class="fas fa-grip-horizontal me-1"></i>グリッド表示
                        </label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="snapToGrid" checked>
                        <label class="form-check-label" for="snapToGrid">
                            <i class="fas fa-magnet me-1"></i>グリッドスナップ
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// shelf_detail.html の JavaScript部分（テンプレート構文修正版）

let selectedProduct = null;
let draggedProduct = null;
let products = new Map();
let isDragging = false;

// 座標変換係数（統一）
const COORD_SCALE = 10; // 1cm = 10px
const DEBUG_MODE = true; // 本番では false

// Django変数をJavaScript変数として定義
const SHELF_ID = {{ shelf.id }};

// デバッグログ関数
function debugLog(message, data = null) {
    if (DEBUG_MODE) {
        console.log(`[DEBUG] ${new Date().toLocaleTimeString()} ${message}`, data || '');
    }
}

// 座標正規化関数（Decimal精度対応）
function normalizeCoordinate(value, precision = 1) {
    const factor = Math.pow(10, precision);
    return Math.round(value * factor) / factor;
}

// 座標変換関数
function pxToCm(px) {
    return normalizeCoordinate(px / COORD_SCALE);
}

function cmToPx(cm) {
    return normalizeCoordinate(cm * COORD_SCALE);
}

$(document).ready(function() {
    initializeSystem();
    if (DEBUG_MODE) {
        addDebugPanel();
        addDebugCommands();
    }
});

function initializeSystem() {
    initializeDragAndDrop();
    setupEventHandlers();
    loadExistingProducts();
    debugLog('システム初期化完了');
}

function initializeDragAndDrop() {
    // 商品パレットのドラッグ設定
    $('.product-palette-item').each(function() {
        this.draggable = true;
        
        $(this).on('dragstart', function(e) {
            const productData = {
                id: $(this).data('product-id'),
                name: $(this).data('product-name'),
                width: parseFloat($(this).data('product-width')),
                height: parseFloat($(this).data('product-height')),
                price: $(this).data('product-price')
            };
            
            draggedProduct = productData;
            e.originalEvent.dataTransfer.effectAllowed = 'copy';
            e.originalEvent.dataTransfer.setData('text/plain', '');
            
            debugLog('ドラッグ開始', productData);
            highlightCompatibleSegments(productData.height);
        });
        
        $(this).on('dragend', function(e) {
            draggedProduct = null;
            $('.shelf-level').removeClass('drop-available drop-unavailable');
            debugLog('ドラッグ終了');
        });
    });
    
    // 棚段のドロップ設定
    $('.shelf-level').each(function() {
        const segment = this;
        const segmentHeight = $(segment).data('segment-height');
        
        $(segment).on('dragover', function(e) {
            e.preventDefault();
            e.originalEvent.dataTransfer.dropEffect = 'copy';
            $(this).addClass('drag-over');
        });
        
        $(segment).on('dragleave', function(e) {
            if (!segment.contains(e.relatedTarget)) {
                $(this).removeClass('drag-over');
            }
        });
        
        $(segment).on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
            
            if (draggedProduct) {
                const rect = segment.getBoundingClientRect();
                const displayX = e.originalEvent.clientX - rect.left;
                const displayY = e.originalEvent.clientY - rect.top;
                
                // グリッドスナップ適用
                const gridX = $('#snapToGrid').is(':checked') ? 
                    Math.round(displayX / 20) * 20 : displayX;
                const gridY = Math.max(10, Math.min(displayY, rect.height - 50));
                
                debugLog('ドロップ座標', {
                    originalX: displayX,
                    gridX: gridX,
                    realX: pxToCm(gridX)
                });
                
                addProductToShelf(segment, draggedProduct, gridX, gridY);
                draggedProduct = null;
            }
        });
        
        // クリック配置
        $(segment).on('click', function(e) {
            if (selectedProduct && !isDragging) {
                const rect = segment.getBoundingClientRect();
                const displayX = e.clientX - rect.left;
                const displayY = e.clientY - rect.top;
                
                const gridX = $('#snapToGrid').is(':checked') ? 
                    Math.round(displayX / 20) * 20 : displayX;
                const gridY = Math.max(10, Math.min(displayY, rect.height - 50));
                
                debugLog('クリック配置', {
                    product: selectedProduct.name,
                    displayX: gridX,
                    realX: pxToCm(gridX)
                });
                
                addProductToShelf(segment, selectedProduct, gridX, gridY);
                deselectProduct();
            }
        });
    });
}

function addProductToShelf(shelfLevel, product, displayX, displayY) {
    const segmentId = $(shelfLevel).data('segment-id');
    const normalizedX = normalizeCoordinate(displayX);
    const realX = pxToCm(normalizedX);
    
    // 商品の表示サイズ計算（統一）
    const productDisplayWidth = cmToPx(product.width);
    const productDisplayHeight = Math.min(cmToPx(product.height * 0.8), 50);
    
    debugLog('商品配置開始', {
        product: product.name,
        segment: segmentId,
        displayX: normalizedX,
        realX: realX,
        productWidth: product.width,
        displayWidth: productDisplayWidth
    });
    
    // サーバーに配置リクエスト
    $.ajax({
        url: "{% url 'shelf:place_product_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            shelf_id: SHELF_ID,
            segment_id: segmentId,
            product_id: product.id,
            x_position: realX,
            face_count: 1
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                showMessage('商品を配置しました', 'success');
                
                // 正確な位置でUI要素を作成
                const finalDisplayX = cmToPx(response.debug_info.x_position);
                createProductElement(
                    shelfLevel, 
                    product, 
                    finalDisplayX, 
                    displayY, 
                    productDisplayWidth, 
                    productDisplayHeight, 
                    response.placement_id
                );
                
                debugLog('配置成功', response.debug_info);
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('配置失敗', response);
            }
        },
        error: function(xhr, status, error) {
            debugLog('配置リクエストエラー', error);
            showMessage('配置に失敗しました', 'error');
        }
    });
}

function createProductElement(shelfLevel, product, displayX, displayY, width, height, placementId) {
    const productElement = $(`
        <div class="product-in-shelf" 
             data-placement-id="${placementId}"
             data-product-id="${product.id}"
             data-facing="1"
             data-product-width="${width}"
             style="left: ${displayX}px; top: ${displayY}px; width: ${width}px; height: ${height}px;">
            
            <div class="single-product" style="
                position: absolute;
                left: 0px;
                width: ${width}px;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2px;
                background: white;
                border-radius: 4px;
            ">
                <div class="product-info">
                    <div class="product-name">${product.name.substring(0, 12)}</div>
                    ${product.price ? `<div class="product-price">¥${product.price}</div>` : ''}
                </div>
            </div>
            
            <div class="facing-controls">
                <button class="facing-btn" onclick="changeFacing('${placementId}', -1)">-</button>
                <span class="px-2 py-1 text-xs bg-white">1</span>
                <button class="facing-btn" onclick="changeFacing('${placementId}', 1)">+</button>
                <button class="remove-product-btn" onclick="removeProduct('${placementId}')">×</button>
            </div>
        </div>
    `);
    
    // ドラッグ移動機能を追加
    setupProductDragging(productElement, placementId);
    
    $(shelfLevel).append(productElement);
    
    debugLog('UI要素作成', {
        placementId: placementId,
        displayX: displayX,
        width: width,
        height: height
    });
}

function setupProductDragging(productElement, placementId) {
    productElement.on('mousedown', function(e) {
        if ($(e.target).closest('.facing-controls').length > 0) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        const startDisplayX = normalizeCoordinate(parseInt($(productElement).css('left')) || 0);
        const startMouseX = e.clientX;
        let originalShelfLevel = $(productElement).closest('.shelf-level');
        let currentShelfLevel = originalShelfLevel;
        
        $(productElement).addClass('dragging');
        $('.shelf-level').addClass('drop-target-available');
        
        debugLog('商品ドラッグ開始', {
            placementId: placementId,
            startDisplayX: startDisplayX,
            startRealX: pxToCm(startDisplayX)
        });
        
        const mouseMoveHandler = function(e) {
            const deltaX = e.clientX - startMouseX;
            const newDisplayX = normalizeCoordinate(startDisplayX + deltaX);
            
            // 段の変更検出
            const elementsAtPoint = document.elementsFromPoint(e.clientX, e.clientY);
            let targetShelfLevel = null;
            
            for (let el of elementsAtPoint) {
                if ($(el).hasClass('shelf-level')) {
                    targetShelfLevel = $(el);
                    break;
                }
            }
            
            if (targetShelfLevel && targetShelfLevel[0] !== currentShelfLevel[0]) {
                currentShelfLevel.removeClass('drag-over-segment');
                currentShelfLevel = targetShelfLevel;
                currentShelfLevel.addClass('drag-over-segment');
                $(productElement).appendTo(currentShelfLevel);
            }
            
            // X軸位置制約
            const currentWidth = parseInt($(productElement).css('width'));
            const shelfWidth = currentShelfLevel.width();
            
            const gridX = $('#snapToGrid').is(':checked') ? 
                Math.round(newDisplayX / 20) * 20 : newDisplayX;
            const constrainedX = Math.max(0, Math.min(gridX, shelfWidth - currentWidth));
            
            // スマートフィット（他の商品との吸着）
            const finalX = applySmartFit(constrainedX, currentWidth, currentShelfLevel, productElement);
            
            $(productElement).css({
                left: finalX + 'px',
                top: '5px'
            });
        };
        
        const mouseUpHandler = function() {
            $(productElement).removeClass('dragging snapping');
            $('.shelf-level').removeClass('drop-target-available drag-over-segment');
            $(document).off('mousemove', mouseMoveHandler);
            $(document).off('mouseup', mouseUpHandler);
            
            // 最終位置での更新
            const finalDisplayX = normalizeCoordinate(parseInt($(productElement).css('left')));
            const finalRealX = pxToCm(finalDisplayX);
            const finalSegmentId = currentShelfLevel.data('segment-id');
            const originalSegmentId = originalShelfLevel.data('segment-id');
            
            debugLog('ドラッグ完了', {
                placementId: placementId,
                originalSegment: originalSegmentId,
                finalSegment: finalSegmentId,
                finalDisplayX: finalDisplayX,
                finalRealX: finalRealX
            });
            
            // サーバーに更新リクエスト
            if (finalSegmentId !== originalSegmentId) {
                // 段間移動
                moveProductBetweenSegments(placementId, finalSegmentId, finalRealX);
            } else {
                // 同一段内移動
                updateProductPosition(placementId, finalRealX);
            }
            
            setTimeout(() => { isDragging = false; }, 100);
        };
        
        $(document).on('mousemove', mouseMoveHandler);
        $(document).on('mouseup', mouseUpHandler);
    });
}

function applySmartFit(constrainedX, currentWidth, currentShelfLevel, excludeElement) {
    const nearbyProducts = currentShelfLevel.find('.product-in-shelf').not(excludeElement);
    let finalX = constrainedX;
    const snapDistance = 40;
    let isSnapping = false;
    
    nearbyProducts.each(function() {
        const otherX = parseInt($(this).css('left'));
        const otherWidth = parseInt($(this).css('width'));
        
        // 右端吸着
        const rightSnapDistance = Math.abs(constrainedX - (otherX + otherWidth));
        if (rightSnapDistance < snapDistance) {
            finalX = otherX + otherWidth;
            isSnapping = true;
            return false;
        }
        
        // 左端吸着
        const leftSnapDistance = Math.abs((constrainedX + currentWidth) - otherX);
        if (leftSnapDistance < snapDistance) {
            finalX = otherX - currentWidth;
            isSnapping = true;
            return false;
        }
    });
    
    if (isSnapping) {
        $(excludeElement).addClass('snapping');
    } else {
        $(excludeElement).removeClass('snapping');
    }
    
    return finalX;
}

function moveProductBetweenSegments(placementId, newSegmentId, newRealX) {
    debugLog('段間移動リクエスト', {
        placementId: placementId,
        newSegmentId: newSegmentId,
        newRealX: newRealX
    });
    
    $.ajax({
        url: "{% url 'shelf:update_placement_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            placement_id: placementId,
            segment_id: newSegmentId,
            x_position: newRealX
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                showMessage('商品を他の段に移動しました', 'success');
                debugLog('段間移動成功', response.debug_info);
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('段間移動失敗', response);
                location.reload();
            }
        },
        error: function(xhr, status, error) {
            debugLog('段間移動エラー', error);
            showMessage('段間移動に失敗しました', 'error');
            location.reload();
        }
    });
}

function updateProductPosition(placementId, newRealX) {
    debugLog('位置更新リクエスト', {
        placementId: placementId,
        newRealX: newRealX
    });
    
    $.ajax({
        url: "{% url 'shelf:update_placement_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            placement_id: placementId,
            x_position: newRealX
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                debugLog('位置更新成功', response.debug_info);
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('位置更新失敗', response);
                location.reload();
            }
        },
        error: function(xhr, status, error) {
            debugLog('位置更新エラー', error);
            showMessage('位置更新に失敗しました', 'error');
        }
    });
}

function changeFacing(placementId, change) {
    debugLog('フェーシング変更', {
        placementId: placementId,
        change: change
    });
    
    $.ajax({
        url: "{% url 'shelf:update_placement_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            placement_id: placementId,
            face_count_change: change
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                updateProductFacing(placementId, response.new_face_count);
                showMessage(`フェーシングを${response.new_face_count}個に変更しました`, 'success');
                debugLog('フェーシング変更成功', response.debug_info);
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('フェーシング変更失敗', response);
            }
        },
        error: function(xhr, status, error) {
            debugLog('フェーシング変更エラー', error);
            showMessage('フェーシング変更に失敗しました', 'error');
        }
    });
}

function updateProductFacing(placementId, newFacing) {
    const element = $(`.product-in-shelf[data-placement-id="${placementId}"]`);
    if (element.length === 0) return;
    
    const productWidth = parseFloat(element.data('product-width'));
    const totalWidth = productWidth * newFacing;
    
    // 要素のサイズとデータを更新
    element.data('facing', newFacing);
    element.css('width', totalWidth + 'px');
    element.find('.facing-controls span').text(newFacing);
    
    // フェーシングインジケーターの更新
    if (newFacing > 1) {
        if (element.find('.facing-indicator').length === 0) {
            element.append(`<div class="facing-indicator">${newFacing}</div>`);
        } else {
            element.find('.facing-indicator').text(newFacing);
        }
    } else {
        element.find('.facing-indicator').remove();
    }
    
    // 商品表示の再構築
    element.find('.single-product').remove();
    
    for (let i = 0; i < newFacing; i++) {
        const singleProduct = $(`
            <div class="single-product" style="
                position: absolute;
                left: ${i * productWidth}px;
                width: ${productWidth}px;
                height: 100%;
                border-right: ${i < newFacing - 1 ? '1px solid #e5e7eb' : 'none'};
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2px;
                background: white;
                box-sizing: border-box;
            ">
                <div class="product-info">
                    <div class="product-name">商品</div>
                </div>
            </div>
        `);
        element.prepend(singleProduct);
    }
    
    debugLog('フェーシング表示更新', {
        placementId: placementId,
        newFacing: newFacing,
        totalWidth: totalWidth
    });
}

function removeProduct(placementId) {
    if (!confirm('この商品を削除しますか？')) {
        return;
    }
    
    debugLog('商品削除', { placementId: placementId });
    
    $.ajax({
        url: "{% url 'shelf:delete_placement_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            placement_id: placementId
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                $(`.product-in-shelf[data-placement-id="${placementId}"]`).remove();
                showMessage('商品を削除しました', 'success');
                debugLog('削除成功');
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('削除失敗', response);
            }
        },
        error: function(xhr, status, error) {
            debugLog('削除エラー', error);
            showMessage('削除に失敗しました', 'error');
        }
    });
}

function setupEventHandlers() {
    // 商品選択
    $('.product-palette-item').on('click', function(e) {
        if (e.which === 1) {
            selectProduct(this);
        }
    });
    
    // グリッド表示切替
    $('#showGrid').on('change', function() {
        const show = $(this).is(':checked');
        if (show) {
            $('.grid-overlay').css('opacity', '0');
            $('.shelf-level:hover .grid-overlay').css('opacity', '1');
        } else {
            $('.grid-overlay').css('opacity', '0');
        }
    });
    
    // 商品検索
    let searchTimeout;
    $('#productSearch').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val().trim();
        
        if (query.length < 2) {
            $('#searchResults').hide();
            return;
        }
        
        searchTimeout = setTimeout(() => searchProducts(query), 300);
    });
}

function loadExistingProducts() {
    $('.product-in-shelf').each(function() {
        const element = this;
        const placementId = $(element).data('placement-id');
        const currentFacing = parseInt($(element).data('facing')) || 1;
        
        // 商品の基本幅を計算
        const currentWidth = parseFloat($(element).css('width'));
        const productWidth = currentWidth / currentFacing;
        $(element).data('product-width', productWidth);
        
        debugLog('既存商品読み込み', {
            placementId: placementId,
            facing: currentFacing,
            totalWidth: currentWidth,
            productWidth: productWidth
        });
        
        // ドラッグ機能を設定
        setupProductDragging($(element), placementId);
    });
}

// その他のユーティリティ関数
function selectProduct(element) {
    $('.product-palette-item').removeClass('selected');
    $(element).addClass('selected');
    
    selectedProduct = {
        id: $(element).data('product-id'),
        name: $(element).data('product-name'),
        width: parseFloat($(element).data('product-width')),
        height: parseFloat($(element).data('product-height')),
        price: $(element).data('product-price')
    };
    
    highlightCompatibleSegments(selectedProduct.height);
    showMessage(`商品「${selectedProduct.name}」を選択しました`, 'info');
    debugLog('商品選択', selectedProduct);
}

function deselectProduct() {
    selectedProduct = null;
    $('.product-palette-item').removeClass('selected');
    $('.shelf-level').removeClass('drop-available drop-unavailable');
    debugLog('商品選択解除');
}

function highlightCompatibleSegments(productHeight) {
    $('.shelf-level').each(function() {
        const segmentHeight = $(this).data('segment-height');
        if (productHeight <= segmentHeight) {
            $(this).addClass('drop-available');
        } else {
            $(this).addClass('drop-unavailable');
        }
    });
}

function clearAllPlacements() {
    if (!confirm('すべての商品配置を削除しますか？この操作は取り消せません。')) {
        return;
    }
    
    debugLog('全配置削除開始');
    
    $.ajax({
        url: "{% url 'shelf:clear_all_placements_ajax' %}",
        type: 'POST',
        data: JSON.stringify({
            shelf_id: SHELF_ID
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                $('.product-in-shelf').remove();
                showMessage(response.message, 'success');
                debugLog('全配置削除成功');
                updateDebugInfo();
            } else {
                showMessage(response.error, 'error');
                debugLog('全配置削除失敗', response);
            }
        },
        error: function(xhr, status, error) {
            debugLog('全配置削除エラー', error);
            showMessage('削除に失敗しました', 'error');
        }
    });
}

function saveLayout() {
    showMessage('レイアウトを保存しました', 'success');
    debugLog('レイアウト保存');
}

function searchProducts(query) {
    $.ajax({
        url: "{% url 'shelf:product_search_ajax' %}",
        data: { q: query },
        success: function(response) {
            displaySearchResults(response.products);
        }
    });
}

function displaySearchResults(products) {
    const resultsDiv = $('#searchResults');
    resultsDiv.empty();
    
    if (products.length === 0) {
        resultsDiv.html('<div class="search-result-item text-muted">該当する商品がありません</div>');
    } else {
        products.forEach(function(product) {
            const item = $(`
                <div class="search-result-item" data-product-id="${product.id}">
                    <div class="fw-bold">${product.name}</div>
                    <div class="text-muted small">${product.maker || ''} | ${product.width}×${product.height}cm</div>
                </div>
            `);
            
            item.on('click', function() {
                const paletteItem = $(`.product-palette-item[data-product-id="${product.id}"]`);
                if (paletteItem.length) {
                    selectProduct(paletteItem[0]);
                    paletteItem[0].scrollIntoView({ behavior: 'smooth' });
                }
                resultsDiv.hide();
                $('#productSearch').val('');
            });
            
            resultsDiv.append(item);
        });
    }
    
    resultsDiv.show();
}

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    setTimeout(() => {
        $('.alert').fadeOut(() => {
            $('.alert').remove();
        });
    }, 3000);
}

// デバッグ機能
function addDebugPanel() {
    const debugPanel = $(`
        <div id="debugPanel" style="
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            z-index: 9999;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #444;
        ">
            <div style="border-bottom: 1px solid #666; margin-bottom: 10px; padding-bottom: 5px;">
                <strong style="color: #4CAF50;">🔧 DEBUG PANEL</strong>
                <button onclick="$('#debugPanel').toggle()" style="float: right; background: none; border: none; color: white;">×</button>
            </div>
            <div id="debugContent">
                <div>座標変換係数: ${COORD_SCALE}</div>
                <div>デバッグモード: ${DEBUG_MODE ? 'ON' : 'OFF'}</div>
                <div>棚ID: ${SHELF_ID}</div>
                <div>初期化完了</div>
            </div>
        </div>
    `);
    
    $('body').append(debugPanel);
}

function updateDebugInfo() {
    if (!DEBUG_MODE) return;
    
    const debugContent = $('#debugContent');
    if (debugContent.length === 0) return;
    
    let content = `
        <div>座標変換係数: ${COORD_SCALE}</div>
        <div>棚ID: ${SHELF_ID}</div>
        <div>選択商品: ${selectedProduct ? selectedProduct.name : 'なし'}</div>
        <div>ドラッグ中: ${isDragging ? 'Yes' : 'No'}</div>
        <div>配置商品数: ${$('.product-in-shelf').length}</div>
        <div style="border-top: 1px solid #666; margin-top: 5px; padding-top: 5px;">配置詳細:</div>
    `;
    
    $('.product-in-shelf').each(function(index) {
        const placementId = $(this).data('placement-id');
        const facing = $(this).data('facing');
        const displayX = parseInt($(this).css('left'));
        const realX = pxToCm(displayX);
        const width = parseInt($(this).css('width'));
        
        content += `<div style="font-size: 10px; color: #ccc;">ID:${placementId} X:${realX}cm (${displayX}px) 幅:${width}px F:${facing}</div>`;
    });
    
    debugContent.html(content);
}

function addDebugCommands() {
    // コンソールコマンドを追加
    window.debugShelf = {
        showCoordinates: function() {
            $('.product-in-shelf').each(function() {
                const id = $(this).data('placement-id');
                const x = parseInt($(this).css('left'));
                const realX = pxToCm(x);
                console.log(`Placement ${id}: Display=${x}px, Real=${realX}cm`);
            });
        },
        
        validatePositions: function() {
            // デバッグURL構築（修正済み）
            const debugUrl = `/shelf/debug/${SHELF_ID}/`;
            $.get(debugUrl, function(data) {
                console.log('Server data:', data);
            }).fail(function(xhr, status, error) {
                console.error('Debug API Error:', error);
                console.log('Debug URL was:', debugUrl);
            });
        },
        
        resetCoordinates: function() {
            $('.product-in-shelf').each(function() {
                const currentX = parseInt($(this).css('left'));
                const normalizedX = normalizeCoordinate(currentX);
                $(this).css('left', normalizedX + 'px');
            });
            console.log('座標を正規化しました');
            updateDebugInfo();
        },
        
        info: function() {
            console.log('=== SHELF DEBUG INFO ===');
            console.log('Shelf ID:', SHELF_ID);
            console.log('Coordinate Scale:', COORD_SCALE);
            console.log('Debug Mode:', DEBUG_MODE);
            console.log('Products on shelf:', $('.product-in-shelf').length);
            console.log('Selected product:', selectedProduct);
            console.log('========================');
        }
    };
    
    console.log('🔧 デバッグコマンド利用可能:');
    console.log('- debugShelf.info() : システム情報');
    console.log('- debugShelf.showCoordinates() : 座標表示');
    console.log('- debugShelf.validatePositions() : サーバーデータと比較');
    console.log('- debugShelf.resetCoordinates() : 座標正規化');
}

// イベントリスナー
$(document).on('keydown', function(e) {
    if (e.key === 'Escape') {
        deselectProduct();
    }
});

$(document).on('click', function(e) {
    if (!$(e.target).closest('#productSearch, #searchResults').length) {
        $('#searchResults').hide();
    }
});

// 表示幅計算の統一確認
function verifyDisplayWidth() {
    console.log('=== 表示幅統一確認 ===');
    
    $('.product-in-shelf').each(function() {
        const placementId = $(this).data('placement-id');
        const facing = parseInt($(this).data('facing')) || 1;
        const productWidthData = parseFloat($(this).data('product-width'));
        const currentDisplayWidth = parseInt($(this).css('width'));
        
        // 理論値計算（商品幅のピクセル値 × フェース数）
        const productWidthCm = productWidthData / 10; // data-product-widthはpx値
        const expectedDisplayWidth = productWidthCm * 10 * facing; // cm * 10 * フェース数
        
        const isMatch = Math.abs(currentDisplayWidth - expectedDisplayWidth) < 1;
        
        console.log(`Placement ${placementId}:`, {
            facing: facing,
            productWidthCm: productWidthCm,
            expected: expectedDisplayWidth,
            actual: currentDisplayWidth,
            match: isMatch ? '✅' : '❌'
        });
        
        if (!isMatch) {
            console.warn(`⚠️ 表示幅不整合: Placement ${placementId}`);
        }
    });
}

// デバッグコマンドに追加
if (typeof window.debugShelf !== 'undefined') {
    window.debugShelf.verifyDisplayWidth = verifyDisplayWidth;
    console.log('- debugShelf.verifyDisplayWidth() : 表示幅整合性チェック');
}

// 定期的なデバッグ情報更新
if (DEBUG_MODE) {
    setInterval(updateDebugInfo, 2000);
}
</script>
{% endblock %}